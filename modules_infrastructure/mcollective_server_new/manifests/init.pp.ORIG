# Class: mcollective server
# This module install the mcollective component on the server.
#
# Parameters:
#
# $mc_server: mcollective server
# $mc_server = 'suwpuppet01.mt2.suw.hostings.op'
#
# $mc_user: mcollective username
# $mc_user = 'mcollective'
#
# $mc_password: mcollective password
# $mc_password = 'marionette'
#
# Sample usage:
#
# class { 'mcollective_server':
#       mc_server       => 'suwpuppet01.mt2.suw.hostings.op',
#       mc_user         => 'mcollective',
#       mc_password     => 'marionette',
# }

class mcollective_server_new ( 	$mc_server      = 'suwpuppet01.mt2.suw.hostings.op',
				$mc_user        = 'mcollective',
				$mc_password    = 'marionette' ) {

	package { ['mcollective-client', 'activemq', 'activemq-info-provider', 'tanukiwrapper', 'rubygems', 'rubygem-stomp', 'jpackage-utils', 'java-1.6.0-openjdk', 'ruby-rdoc']:
		ensure		=>	present,
	}

	# "File" Type is a code compresiion technique which defined default value to be used within this scope.
	File {
                owner		=>	root,
                group		=>	root,
                mode		=>	0744,
	}

	file { 'client.cfg':
		ensure		=>	present,
		path		=>	'/etc/mcollective/client.cfg',
                mode		=>	0640,
		require		=>	Package['mcollective'],
		notify		=>	Service['mcollective'],
		content		=>	template('mcollective_server_new/client.cfg.erb'),
	}

	file { 'activemq.xml':
		ensure		=>	present,
		path		=>	'/etc/activemq/activemq.xml',
                mode		=>	0644,
		require		=>	Package['mcollective'],
		notify		=>	Service['mcollective'],
		content		=>	template('mcollective_server_new/activemq.xml.erb'),
	}

	file { 'mc-service':
		ensure		=>	present,
                path		=>	'/usr/libexec/mcollective/mcollective/application/mc-service',
                require		=>      File['client.cfg'],
                source		=>	'puppet:///modules/mcollective_server_new/mc-service',
        }

	file { '/usr/local/sbin/mc-service':
		ensure		=>	link,
		target		=>	'/usr/libexec/mcollective/mcollective/application/mc-service'
	}

	file { 'mc-filemgr':
		ensure		=>	present,
                path		=>	'/usr/libexec/mcollective/mcollective/application/mc-filemgr',
                require		=>	File['client.cfg'],
                source		=>	'puppet:///modules/mcollective_server_new/mc-filemgr',
        }

	file { '/usr/local/sbin/mc-filemgr':
		ensure		=>	link,
		target		=>	'/usr/libexec/mcollective/mcollective/application/mc-filemgr'
	}

	file { 'mc-shellcmd':
		ensure		=>	present,
                path		=>	'/usr/libexec/mcollective/mcollective/application/mc-shellcmd',
                require		=>	File['client.cfg'],
                source		=>	'puppet:///modules/mcollective_server_new/mc-shellcmd',
        }

	file { '/usr/local/sbin/mc-shellcmd':
		ensure		=>	link,
		target		=>	'/usr/libexec/mcollective/mcollective/application/mc-shellcmd'
	}

	file { 'mc-package':
		ensure		=>	present,
                path		=>	'/usr/libexec/mcollective/mcollective/application/mc-package',
                require		=>	File['client.cfg'],
                source		=>	'puppet:///modules/mcollective_server_new/mc-package',
        }

	file { '/usr/local/sbin/mc-package':
		ensure		=>	link,
		target		=>	'/usr/libexec/mcollective/mcollective/application/mc-package'
	}

	service { 'activemq':
		enable		=>	true,
		ensure		=>	running,
		subscribe	=>	File['/etc/activemq/activemq.xml'],
                require		=>      Package['mcollective-client', 'activemq', 'activemq-info-provider', 'tanukiwrapper', 'rubygems', 'rubygem-stomp', 'jpackage-utils', 'java-1.6.0-openjdk', 'ruby-irb', 'ruby-rdoc'],
	}

} # End of class mcollective_server_new
